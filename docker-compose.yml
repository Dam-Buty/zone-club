services:
  traefik:
    image: traefik:v3.0
    container_name: zone-traefik
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik:/etc/traefik
    networks:
      - zone-network

  sveltekit:
    build: ./app
    container_name: zone-app
    environment:
      - DATABASE_PATH=/data/zone.db
      - DOMAIN=${DOMAIN}
      - SUBDOMAIN=${SUBDOMAIN}
      - STORAGE_SUBDOMAIN=${STORAGE_SUBDOMAIN}
      - RADARR_URL=http://radarr:7878
      - RADARR_API_KEY=${RADARR_API_KEY}
      - TMDB_API_KEY=${TMDB_API_KEY}
      - HMAC_SECRET=${HMAC_SECRET}
    volumes:
      - db_data:/data
      - media_films:/media/films:ro
      - media_public:/media/public:rw
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.app.rule=Host(`${SUBDOMAIN}.${DOMAIN}`)"
      - "traefik.http.routers.app.entrypoints=websecure"
      - "traefik.http.routers.app.tls.certresolver=letsencrypt"
      - "traefik.http.services.app.loadbalancer.server.port=3000"
    networks:
      - zone-network
    depends_on:
      - radarr

  lighttpd:
    image: sebp/lighttpd
    container_name: zone-storage
    volumes:
      - media_films:/media/films:ro
      - media_public:/media/public:ro
      - ./lighttpd.conf:/etc/lighttpd/lighttpd.conf:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.storage.rule=Host(`${STORAGE_SUBDOMAIN}.${DOMAIN}`)"
      - "traefik.http.routers.storage.entrypoints=websecure"
      - "traefik.http.routers.storage.tls.certresolver=letsencrypt"
      - "traefik.http.services.storage.loadbalancer.server.port=80"
    networks:
      - zone-network

  radarr:
    image: linuxserver/radarr:latest
    container_name: zone-radarr
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Paris
    volumes:
      - radarr_config:/config
      - media_films:/movies
      - ${TRANSMISSION_DOWNLOADS}:/downloads
    networks:
      - zone-network
    extra_hosts:
      - "host.docker.internal:host-gateway"

networks:
  zone-network:
    driver: bridge

volumes:
  db_data:
  media_films:
  media_public:
  radarr_config:
