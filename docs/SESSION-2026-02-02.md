# Session du 2 Février 2026 - Video Club WebGPU

## Résumé des travaux effectués

### 1. Système de ciblage des cassettes (FPS-style)

**Problème initial :**
- Le ciblage des cassettes utilisait les événements pointer de R3F (`onPointerOver`, `onClick`)
- Quand le pointer était locké (mode FPS), il y avait un décalage de 15% nord-ouest entre le crosshair et la sélection
- Les événements pointer suivaient la position réelle de la souris, pas le centre de l'écran

**Solution implémentée :**
- Suppression des événements pointer sur les composants `Cassette`
- Raycasting continu dans `useFrame` depuis le centre de l'écran (0,0) quand le pointer est locké
- Ajout de `targetedFilmId` et `targetedCassetteKey` dans le store Zustand
- Chaque cassette a maintenant un identifiant unique basé sur sa position (`cassetteKey`)

**Fichiers modifiés :**
- `src/store/index.ts` - Ajout de `targetedFilmId`, `targetedCassetteKey`, `isPointerLocked`
- `src/components/interior/Controls.tsx` - Raycasting dans useFrame, gestion lock/unlock
- `src/components/interior/Cassette.tsx` - Utilisation du store pour le hover effect
- `src/components/interior/WallShelf.tsx` - Passage du `cassetteKey` unique
- `src/components/interior/IslandShelf.tsx` - Passage du `cassetteKey` unique
- `src/components/interior/Shelf.tsx` - Passage du `cassetteKey` unique

### 2. Message "Cliquez pour prendre le contrôle"

**Ajout :**
- Message stylisé affiché au centre de l'écran quand le pointer n'est pas locké
- Le crosshair et les instructions de contrôle ne s'affichent que quand locké
- Tracking de l'état `isPointerLocked` dans le store via événements `lock`/`unlock`

**Fichiers modifiés :**
- `src/store/index.ts` - Ajout de `isPointerLocked`, `setPointerLocked`
- `src/components/interior/Controls.tsx` - Event listeners lock/unlock
- `src/components/interior/InteriorScene.tsx` - Affichage conditionnel du message et du crosshair

### 3. Liste de films personnalisée (Vidéothèque)

**Problème initial :**
- Les films étaient des IDs TMDB génériques/inventés
- Même film affiché plusieurs fois = sélection multiple simultanée

**Solution :**
- Extraction des IDs IMDB depuis le PDF "Vidéothèque liste 2.pdf"
- Script Node.js pour convertir 141 IDs IMDB → 140 IDs TMDB via l'API TMDB
- Répartition des films dans les catégories : nouveautes, action, horreur, sf, comedie, classiques, bizarre

**Fichiers créés/modifiés :**
- `scripts/convert_ids.js` - Script de conversion IMDB → TMDB
- `src/data/mock/films.json` - 140 vrais films de la vidéothèque personnelle

## Leçons apprises

### Architecture de ciblage FPS en Three.js/R3F

```
┌─────────────────────────────────────────────────────────┐
│  AVANT (problématique)                                  │
│  ───────────────────────                                │
│  Événements pointer R3F → Position souris réelle        │
│  Problème: décalage quand pointer locké                 │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│  APRÈS (correct)                                        │
│  ──────────────────                                     │
│  useFrame → Raycast depuis (0,0) → Store Zustand        │
│  Cassette lit targetedCassetteKey du store              │
│  Pas d'événements pointer sur les meshes                │
└─────────────────────────────────────────────────────────┘
```

### Identification unique des objets 3D

Pour éviter les sélections multiples d'objets identiques :
- Utiliser une clé basée sur la **position** plutôt que l'**ID de contenu**
- Format: `{shelf-type}-{position}-{row}-{col}`
- Stocker à la fois la clé unique ET l'ID de contenu dans `userData`

### Conversion IMDB → TMDB

L'API TMDB permet de trouver un film par son ID IMDB :
```
GET https://api.themoviedb.org/3/find/{imdb_id}?external_source=imdb_id
```

## État actuel du projet

- ✅ Intérieur du video club en React Three Fiber v9 + WebGPU
- ✅ Navigation FPS avec PointerLockControls
- ✅ Ciblage précis des cassettes via crosshair central
- ✅ 140 films de la vidéothèque personnelle
- ✅ Étagères murales et îlot central remplis de cassettes
- ✅ Signalétique néon (MANAGER, GAMES, genres)
- ✅ TV cathodique avec VCR
- ✅ Section GAMES avec boîtiers de jeux

---

## Session du 2 Février 2026 (suite) - UX et Layout

### 4. Gestion du Pointer Lock

**Implémentation :**
- Ajout de `requestPointerLock()` et `requestPointerUnlock()` dans le store Zustand
- `pointerLockRequested: 'lock' | 'unlock' | null` pour communication inter-composants
- Controls.tsx écoute ces requêtes et appelle `controls.lock()` ou `controls.unlock()`

**Utilisation :**
- Chat Manager : auto-unlock à l'ouverture, auto-lock à la fermeture
- Empêche le lock quand le chat est visible

### 5. Fermeture chat par double-clic extérieur

**Implémentation :**
- Compteur `outsideClickCount` dans ManagerChat
- Détection des clics hors du `containerRef`
- 2 clics consécutifs = fermeture du chat
- Reset du compteur si clic intérieur

### 6. Collisions AABB

**Zones de collision définies :**
```typescript
COLLISION_ZONES = [
  { comptoir },
  { ilot },
  { tv },
  { etagere-gauche },
  { etagere-fond },
  { etagere-droite-nord },
  { games },
  { escalier },
  { porte-privee },
  { plante }
]
```

**Comportement :**
- Marge de collision de 7% (COLLISION_MARGIN = 0.07)
- Slide-along: si bloqué en XZ, essaie X seul, puis Z seul
- Limites des murs avec WALL_MARGIN = 0.5

### 7. Zone Manager élargie

**MANAGER_ZONE :**
```typescript
{
  minX: ROOM_WIDTH / 2 - 2.3 - 2,
  maxX: ROOM_WIDTH / 2 - 2.3 + 2,
  minZ: ROOM_DEPTH / 2 - 1.5 - 1.5,
  maxZ: ROOM_DEPTH / 2 - 1.5 + 2
}
```

- Interaction avec E ou clic quand dans la zone
- Priorité sur la sélection de cassette

### 8. Posters muraux

**Configuration finale :**
- 9 posters (slice 0-9)
- Taille: 0.51 × 0.73 (agrandi ~50%)
- Espacement: 0.56
- Position: [2.2, 2.3, ROOM_DEPTH/2 - 0.15]
- 12 posterPaths extraits pour éviter les manques

---

## État du Manager3D - Analyse pour refonte

### Structure actuelle
```
Manager3D
├── Tête: GLB (quentin_head.glb, 24MB) + texture Quentin.webp
│   └── Position: [0, 1.68, 0], scale: 0.06
├── Cou: cylinderGeometry
│   └── Position: [0, 1.55, 0]
├── Torse: boxGeometry (polo bleu #1a3a5c)
├── Bras: capsuleGeometry (chemise + peau)
├── Bassin: boxGeometry (pantalon noir)
├── Jambes: capsuleGeometry
└── Pieds: boxGeometry (chaussures noires)
```

### Problèmes identifiés
1. **Gap tête-corps** : headY=1.68, neckY=1.55 → espace visible entre le modèle GLB et le cou
2. **Mapping texture** : La texture Quentin.webp est appliquée uniformément, pas selon les UVs du modèle
3. **Vêtements basiques** : Pas de blouson en cuir, juste des couleurs plates

### Fichiers modèles disponibles
- `/public/models/quentin_head.glb` (24 MB)
- `/public/models/Quentin.webp` (140 KB)

---

## Prochaine étape: Refonte Manager3D

### Objectifs
1. Éliminer le gap entre la tête et le corps
2. Appliquer correctement la texture sur la tête (UV mapping)
3. Ajouter un blouson en cuir avec texture de qualité (normal map, roughness)

### Questions à explorer
- Comment sont mappés les UVs sur quentin_head.glb ?
- Ajuster BODY.headY et BODY.neckY pour aligner tête et cou ?
- Créer une géométrie de blouson ou modifier le torse existant ?
- Textures PBR pour le cuir (baseColor, normal, roughness)
