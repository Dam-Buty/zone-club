# VideoClub 2.0 - Implementation Plan (Part 2)

## R√àGLES OBLIGATOIRES - PROJET 3D

**AVANT de coder:**
1. √âtudier l'image de r√©f√©rence pixel par pixel
2. Rechercher l'√©tat de l'art (pas d'improvisation!)
3. Utiliser les outils existants (NeonTube.ts, TextureLoader, etc.)
4. V√©rifier visuellement CHAQUE modification

**INTERDIT:** Bo√Ætes par paresse, suppositions, marquer "compl√©t√©" sans v√©rification visuelle.

---

> **For Claude:** This is a continuation of `2026-01-30-videoclub-2.0-implementation.md`. Execute Part 1 first.

---

## Phase 5 (continued): React UI Components

### Task 17: Create FilmDetailModal component

**File:** `src/components/videoclub/FilmDetailModal.tsx`

**Step 1: Write component**
```tsx
import { useStore } from '../../store';
import { tmdb } from '../../services/tmdb';
import { Modal } from '../ui/Modal';
import { RENTAL_COSTS, RENTAL_DURATIONS, type Film, type RentalTier } from '../../types';
import styles from './FilmDetailModal.module.css';

interface FilmDetailModalProps {
  film: Film | null;
  isOpen: boolean;
  onClose: () => void;
}

function getRentalTier(film: Film): RentalTier {
  const year = new Date(film.release_date).getFullYear();
  const currentYear = new Date().getFullYear();

  if (currentYear - year <= 1) return 'nouveaute';
  if (currentYear - year >= 20) return 'classique';
  return 'standard';
}

function formatDuration(ms: number): string {
  const hours = ms / (1000 * 60 * 60);
  if (hours >= 24) return `${Math.floor(hours / 24)} jours`;
  return `${hours}h`;
}

export function FilmDetailModal({ film, isOpen, onClose }: FilmDetailModalProps) {
  const { user, deductCredits, addRental, getRental } = useStore();

  if (!film) return null;

  const tier = getRentalTier(film);
  const cost = RENTAL_COSTS[tier];
  const duration = RENTAL_DURATIONS[tier];
  const isRented = !!getRental(film.id);
  const canAfford = user.credits >= cost;

  const handleRent = () => {
    if (!canAfford || isRented) return;

    const success = deductCredits(cost);
    if (success) {
      addRental({
        filmId: film.id,
        rentedAt: Date.now(),
        expiresAt: Date.now() + duration,
        videoUrl: `/videos/${film.id}.mp4`,
      });
      onClose();
    }
  };

  return (
    <Modal isOpen={isOpen} onClose={onClose}>
      <div
        className={styles.backdrop}
        style={{
          backgroundImage: film.backdrop_path
            ? `url(${tmdb.backdropUrl(film.backdrop_path)})`
            : undefined,
        }}
      />
      <div className={styles.content}>
        <img
          src={tmdb.posterUrl(film.poster_path)}
          alt={film.title}
          className={styles.poster}
        />
        <div className={styles.info}>
          <h2 className={styles.title}>{film.title}</h2>
          <div className={styles.meta}>
            <span>{new Date(film.release_date).getFullYear()}</span>
            {film.runtime && <span>{film.runtime} min</span>}
            <span className={styles.rating}>‚òÖ {film.vote_average.toFixed(1)}</span>
          </div>
          <div className={styles.genres}>
            {film.genres.map((g) => (
              <span key={g.id} className={styles.genre}>{g.name}</span>
            ))}
          </div>
          <p className={styles.overview}>{film.overview}</p>

          <div className={styles.rental}>
            <div className={styles.rentalInfo}>
              <span className={styles.cost}>{cost} cr√©dit{cost > 1 ? 's' : ''}</span>
              <span className={styles.duration}>{formatDuration(duration)}</span>
            </div>
            {isRented ? (
              <button className={styles.rentedButton} disabled>
                D√©j√† lou√©
              </button>
            ) : (
              <button
                className={styles.rentButton}
                onClick={handleRent}
                disabled={!canAfford}
              >
                {canAfford ? 'Louer' : 'Cr√©dits insuffisants'}
              </button>
            )}
          </div>
        </div>
      </div>
    </Modal>
  );
}
```

**File:** `src/components/videoclub/FilmDetailModal.module.css`

**Step 2: Write styles**
```css
.backdrop {
  position: absolute;
  inset: 0;
  background-size: cover;
  background-position: center;
  opacity: 0.2;
  z-index: -1;
}

.content {
  display: flex;
  gap: var(--space-xl);
  max-width: 800px;
}

.poster {
  width: 250px;
  height: auto;
  border-radius: 4px;
  box-shadow: 0 0 20px rgba(255, 45, 149, 0.3);
  flex-shrink: 0;
}

.info {
  flex: 1;
}

.title {
  font-family: var(--font-display);
  font-size: 2rem;
  color: var(--neon-cyan);
  text-shadow: var(--glow-cyan);
  margin-bottom: var(--space-md);
}

.meta {
  display: flex;
  gap: var(--space-md);
  color: rgba(255, 255, 255, 0.7);
  margin-bottom: var(--space-md);
}

.rating {
  color: var(--neon-yellow);
}

.genres {
  display: flex;
  flex-wrap: wrap;
  gap: var(--space-sm);
  margin-bottom: var(--space-lg);
}

.genre {
  padding: var(--space-xs) var(--space-sm);
  background: rgba(176, 38, 255, 0.2);
  border: 1px solid var(--neon-purple);
  border-radius: 4px;
  font-size: 0.75rem;
  color: var(--neon-purple);
}

.overview {
  line-height: 1.6;
  color: rgba(255, 255, 255, 0.9);
  margin-bottom: var(--space-xl);
}

.rental {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-top: var(--space-lg);
  border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.rentalInfo {
  display: flex;
  flex-direction: column;
}

.cost {
  font-family: var(--font-display);
  font-size: 1.25rem;
  color: var(--neon-yellow);
}

.duration {
  font-size: 0.875rem;
  color: rgba(255, 255, 255, 0.5);
}

.rentButton {
  padding: var(--space-md) var(--space-xl);
  background: linear-gradient(135deg, var(--neon-pink), var(--neon-purple));
  border: none;
  border-radius: 4px;
  color: white;
  font-family: var(--font-display);
  font-size: 1rem;
  cursor: pointer;
  transition: transform var(--transition-fast), box-shadow var(--transition-fast);
}

.rentButton:hover:not(:disabled) {
  transform: scale(1.05);
  box-shadow: var(--glow-pink);
}

.rentButton:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.rentedButton {
  padding: var(--space-md) var(--space-xl);
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 4px;
  color: rgba(255, 255, 255, 0.5);
  font-family: var(--font-display);
  cursor: not-allowed;
}
```

**Step 3: Commit**
```bash
git add src/components/videoclub/FilmDetailModal.tsx src/components/videoclub/FilmDetailModal.module.css && git commit -m "feat: create FilmDetailModal with rental functionality"
```

---

### Task 18: Create MesLocations component

**File:** `src/components/videoclub/MesLocations.tsx`

**Step 1: Write component**
```tsx
import { useEffect, useState } from 'react';
import { useStore } from '../../store';
import { tmdb } from '../../services/tmdb';
import { RentalTimer } from '../ui/RentalTimer';
import type { Film } from '../../types';
import styles from './MesLocations.module.css';

export function MesLocations() {
  const { rentals, removeRental, openPlayer } = useStore();
  const [films, setFilms] = useState<Record<number, Film>>({});

  // Fetch film details for rentals
  useEffect(() => {
    const fetchFilms = async () => {
      const filmIds = rentals.map((r) => r.filmId).filter((id) => !films[id]);
      if (filmIds.length === 0) return;

      const fetchedFilms = await tmdb.getFilms(filmIds);
      const filmsMap = fetchedFilms.reduce((acc, film) => {
        acc[film.id] = film;
        return acc;
      }, {} as Record<number, Film>);

      setFilms((prev) => ({ ...prev, ...filmsMap }));
    };

    fetchFilms();
  }, [rentals]);

  // Check for expired rentals
  useEffect(() => {
    const interval = setInterval(() => {
      const now = Date.now();
      rentals.forEach((rental) => {
        if (rental.expiresAt < now) {
          removeRental(rental.filmId);
        }
      });
    }, 60000); // Check every minute

    return () => clearInterval(interval);
  }, [rentals, removeRental]);

  if (rentals.length === 0) {
    return (
      <div className={styles.empty}>
        <p>Aucune location en cours</p>
        <p className={styles.hint}>Parcours les rayons et loue des films !</p>
      </div>
    );
  }

  return (
    <div className={styles.container}>
      <h2 className={styles.title}>Mes Locations</h2>
      <div className={styles.grid}>
        {rentals.map((rental) => {
          const film = films[rental.filmId];
          return (
            <div key={rental.filmId} className={styles.card}>
              <div
                className={styles.poster}
                style={{
                  backgroundImage: film
                    ? `url(${tmdb.posterUrl(film.poster_path, 'w342')})`
                    : undefined,
                }}
                onClick={() => openPlayer(rental.filmId)}
              >
                <div className={styles.playOverlay}>
                  <span className={styles.playIcon}>‚ñ∂</span>
                </div>
              </div>
              <div className={styles.info}>
                <span className={styles.filmTitle}>
                  {film?.title || 'Chargement...'}
                </span>
                <RentalTimer expiresAt={rental.expiresAt} compact />
              </div>
            </div>
          );
        })}
      </div>
    </div>
  );
}
```

**File:** `src/components/videoclub/MesLocations.module.css`

**Step 2: Write styles**
```css
.container {
  padding: var(--space-lg);
}

.title {
  font-family: var(--font-display);
  color: var(--neon-cyan);
  text-shadow: var(--glow-cyan);
  margin-bottom: var(--space-lg);
}

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: var(--space-lg);
}

.card {
  display: flex;
  flex-direction: column;
  gap: var(--space-sm);
}

.poster {
  aspect-ratio: 2/3;
  background-size: cover;
  background-position: center;
  background-color: var(--card-bg);
  border-radius: 4px;
  cursor: pointer;
  position: relative;
  overflow: hidden;
  border: 2px solid transparent;
  transition: border-color var(--transition-fast), transform var(--transition-fast);
}

.poster:hover {
  border-color: var(--neon-pink);
  transform: scale(1.02);
}

.poster:hover .playOverlay {
  opacity: 1;
}

.playOverlay {
  position: absolute;
  inset: 0;
  background: rgba(0, 0, 0, 0.6);
  display: flex;
  justify-content: center;
  align-items: center;
  opacity: 0;
  transition: opacity var(--transition-fast);
}

.playIcon {
  font-size: 3rem;
  color: var(--neon-pink);
  text-shadow: var(--glow-pink);
}

.info {
  display: flex;
  flex-direction: column;
  gap: var(--space-xs);
}

.filmTitle {
  font-size: 0.875rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.empty {
  text-align: center;
  padding: var(--space-xl);
  color: rgba(255, 255, 255, 0.5);
}

.hint {
  font-size: 0.875rem;
  margin-top: var(--space-sm);
}
```

**Step 3: Commit**
```bash
git add src/components/videoclub/MesLocations.tsx src/components/videoclub/MesLocations.module.css && git commit -m "feat: create MesLocations component with rental grid and expiration"
```

---

## Phase 6: Manager Components

### Task 19: Create ManagerAvatar component

**File:** `src/components/manager/ManagerAvatar.tsx`

**Step 1: Write component**
```tsx
import { useStore } from '../../store';
import styles from './ManagerAvatar.module.css';

export function ManagerAvatar() {
  const { managerVisible } = useStore();

  if (!managerVisible) return null;

  return (
    <div className={styles.container}>
      <div className={styles.avatar}>
        <div className={styles.face}>
          <div className={styles.glasses}>
            <div className={styles.lens} />
            <div className={styles.lens} />
          </div>
          <div className={styles.mouth} />
        </div>
        <div className={styles.body}>
          <div className={styles.shirt} />
        </div>
      </div>
    </div>
  );
}
```

**File:** `src/components/manager/ManagerAvatar.module.css`

**Step 2: Write styles**
```css
.container {
  position: fixed;
  bottom: 100px;
  left: var(--space-lg);
  z-index: 150;
  animation: slideIn 300ms ease;
}

@keyframes slideIn {
  from {
    transform: translateX(-100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

.avatar {
  width: 80px;
  height: 100px;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.face {
  width: 60px;
  height: 60px;
  background: #f5d0a9;
  border-radius: 50%;
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  box-shadow: 0 0 20px rgba(255, 45, 149, 0.3);
}

.glasses {
  display: flex;
  gap: 4px;
  margin-bottom: 8px;
}

.lens {
  width: 18px;
  height: 14px;
  background: rgba(0, 0, 0, 0.8);
  border: 2px solid #333;
  border-radius: 3px;
}

.mouth {
  width: 20px;
  height: 8px;
  border-bottom: 3px solid #c44;
  border-radius: 0 0 10px 10px;
}

.body {
  width: 50px;
  height: 40px;
  margin-top: -5px;
}

.shirt {
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, #2a4858, #1a3040);
  border-radius: 0 0 10px 10px;
  position: relative;
}

.shirt::before {
  content: '';
  position: absolute;
  top: 5px;
  left: 50%;
  transform: translateX(-50%);
  width: 0;
  height: 0;
  border-left: 8px solid transparent;
  border-right: 8px solid transparent;
  border-top: 10px solid #f5d0a9;
}
```

**Step 3: Commit**
```bash
git add src/components/manager/ManagerAvatar.tsx src/components/manager/ManagerAvatar.module.css && git commit -m "feat: create ManagerAvatar component with CSS illustration"
```

---

### Task 20: Create SpeechBubble component

**File:** `src/components/manager/SpeechBubble.tsx`

**Step 1: Write component**
```tsx
import styles from './SpeechBubble.module.css';

interface SpeechBubbleProps {
  text: string;
  onClose?: () => void;
}

export function SpeechBubble({ text, onClose }: SpeechBubbleProps) {
  return (
    <div className={styles.bubble}>
      <p className={styles.text}>{text}</p>
      {onClose && (
        <button className={styles.close} onClick={onClose}>
          ‚úï
        </button>
      )}
      <div className={styles.tail} />
    </div>
  );
}
```

**File:** `src/components/manager/SpeechBubble.module.css`

**Step 2: Write styles**
```css
.bubble {
  position: relative;
  background: var(--card-bg);
  border: 2px solid var(--neon-cyan);
  border-radius: 12px;
  padding: var(--space-md) var(--space-lg);
  max-width: 350px;
  box-shadow: var(--glow-cyan);
  animation: popIn 200ms ease;
}

@keyframes popIn {
  from {
    transform: scale(0.8);
    opacity: 0;
  }
  to {
    transform: scale(1);
    opacity: 1;
  }
}

.text {
  font-size: 0.95rem;
  line-height: 1.5;
  color: white;
  margin: 0;
}

.close {
  position: absolute;
  top: var(--space-xs);
  right: var(--space-sm);
  background: none;
  border: none;
  color: var(--neon-cyan);
  cursor: pointer;
  font-size: 0.875rem;
  opacity: 0.7;
  transition: opacity var(--transition-fast);
}

.close:hover {
  opacity: 1;
}

.tail {
  position: absolute;
  bottom: -10px;
  left: 30px;
  width: 0;
  height: 0;
  border-left: 10px solid transparent;
  border-right: 10px solid transparent;
  border-top: 10px solid var(--neon-cyan);
}

.tail::before {
  content: '';
  position: absolute;
  top: -12px;
  left: -8px;
  width: 0;
  height: 0;
  border-left: 8px solid transparent;
  border-right: 8px solid transparent;
  border-top: 8px solid var(--card-bg);
}
```

**Step 3: Commit**
```bash
git add src/components/manager/SpeechBubble.tsx src/components/manager/SpeechBubble.module.css && git commit -m "feat: create SpeechBubble component with neon styling"
```

---

### Task 21: Create ManagerChat component

**File:** `src/components/manager/ManagerChat.tsx`

**Step 1: Write component**
```tsx
import { useState, useRef, useEffect } from 'react';
import { useStore } from '../../store';
import { ManagerAvatar } from './ManagerAvatar';
import { SpeechBubble } from './SpeechBubble';
import managerResponses from '../../data/mock/manager-responses.json';
import styles from './ManagerChat.module.css';

export function ManagerChat() {
  const {
    managerVisible,
    hideManager,
    chatHistory,
    addChatMessage,
    claimDailyBonus,
    currentAisle,
  } = useStore();
  const [inputValue, setInputValue] = useState('');
  const chatEndRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [chatHistory]);

  // Check for bonus after messages
  useEffect(() => {
    if (chatHistory.length >= 6) {
      const claimed = claimDailyBonus();
      if (claimed) {
        setTimeout(() => {
          addChatMessage(
            'manager',
            "Tiens, prends √ßa. +1 cr√©dit. C'est toujours un plaisir de parler cin√© avec quelqu'un qui s'y conna√Æt."
          );
        }, 1000);
      }
    }
  }, [chatHistory.length]);

  const getManagerResponse = (userMessage: string): string => {
    const lower = userMessage.toLowerCase();

    // Check for aisle remarks
    if (lower.includes('rayon') || lower.includes('genre')) {
      const aisleKey = currentAisle as keyof typeof managerResponses.aisles;
      if (managerResponses.aisles[aisleKey]) {
        return managerResponses.aisles[aisleKey];
      }
    }

    // Check for film-specific queries (by checking if any film ID is mentioned)
    for (const [filmId, data] of Object.entries(managerResponses.films)) {
      if (lower.includes(filmId)) {
        const anecdotes = data.anecdotes;
        return anecdotes[Math.floor(Math.random() * anecdotes.length)];
      }
    }

    // Default greetings
    const greetings = managerResponses.greeting;
    return greetings[Math.floor(Math.random() * greetings.length)];
  };

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if (!inputValue.trim()) return;

    addChatMessage('user', inputValue);
    setInputValue('');

    // Simulate manager thinking
    setTimeout(() => {
      const response = getManagerResponse(inputValue);
      addChatMessage('manager', response);
    }, 500 + Math.random() * 500);
  };

  if (!managerVisible) return null;

  return (
    <div className={styles.container}>
      <ManagerAvatar />

      <div className={styles.chatPanel}>
        <div className={styles.header}>
          <span className={styles.name}>Le G√©rant</span>
          <button className={styles.closeBtn} onClick={hideManager}>
            ‚úï
          </button>
        </div>

        <div className={styles.messages}>
          {chatHistory.length === 0 && (
            <SpeechBubble
              text={managerResponses.greeting[0]}
            />
          )}
          {chatHistory.map((msg, i) => (
            <div
              key={i}
              className={`${styles.message} ${styles[msg.role]}`}
            >
              {msg.text}
            </div>
          ))}
          <div ref={chatEndRef} />
        </div>

        <form className={styles.inputArea} onSubmit={handleSubmit}>
          <input
            type="text"
            value={inputValue}
            onChange={(e) => setInputValue(e.target.value)}
            placeholder="Pose ta question..."
            className={styles.input}
          />
          <button type="submit" className={styles.sendBtn}>
            ‚Üí
          </button>
        </form>
      </div>
    </div>
  );
}
```

**File:** `src/components/manager/ManagerChat.module.css`

**Step 2: Write styles**
```css
.container {
  position: fixed;
  bottom: var(--space-lg);
  left: var(--space-lg);
  z-index: 150;
  display: flex;
  flex-direction: column;
  gap: var(--space-md);
}

.chatPanel {
  width: 380px;
  background: var(--card-bg);
  border: 1px solid var(--neon-cyan);
  border-radius: 12px;
  overflow: hidden;
  box-shadow: var(--glow-cyan), 0 10px 40px rgba(0, 0, 0, 0.5);
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: var(--space-md) var(--space-lg);
  background: rgba(0, 255, 247, 0.1);
  border-bottom: 1px solid rgba(0, 255, 247, 0.2);
}

.name {
  font-family: var(--font-display);
  color: var(--neon-cyan);
  font-size: 0.875rem;
  letter-spacing: 0.1em;
}

.closeBtn {
  background: none;
  border: none;
  color: var(--neon-cyan);
  cursor: pointer;
  font-size: 1.25rem;
  opacity: 0.7;
  transition: opacity var(--transition-fast);
}

.closeBtn:hover {
  opacity: 1;
}

.messages {
  height: 300px;
  overflow-y: auto;
  padding: var(--space-lg);
  display: flex;
  flex-direction: column;
  gap: var(--space-md);
}

.message {
  max-width: 85%;
  padding: var(--space-sm) var(--space-md);
  border-radius: 12px;
  font-size: 0.9rem;
  line-height: 1.4;
}

.manager {
  align-self: flex-start;
  background: rgba(0, 255, 247, 0.1);
  border: 1px solid rgba(0, 255, 247, 0.3);
  color: white;
}

.user {
  align-self: flex-end;
  background: rgba(255, 45, 149, 0.2);
  border: 1px solid rgba(255, 45, 149, 0.3);
  color: white;
}

.inputArea {
  display: flex;
  gap: var(--space-sm);
  padding: var(--space-md);
  background: rgba(0, 0, 0, 0.3);
  border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.input {
  flex: 1;
  padding: var(--space-sm) var(--space-md);
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 20px;
  color: white;
  font-size: 0.9rem;
}

.input::placeholder {
  color: rgba(255, 255, 255, 0.4);
}

.input:focus {
  outline: none;
  border-color: var(--neon-cyan);
}

.sendBtn {
  width: 40px;
  height: 40px;
  background: var(--neon-cyan);
  border: none;
  border-radius: 50%;
  color: var(--darker-bg);
  font-size: 1.25rem;
  cursor: pointer;
  transition: transform var(--transition-fast), box-shadow var(--transition-fast);
}

.sendBtn:hover {
  transform: scale(1.05);
  box-shadow: var(--glow-cyan);
}
```

**Step 3: Commit**
```bash
git add src/components/manager/ManagerChat.tsx src/components/manager/ManagerChat.module.css && git commit -m "feat: create ManagerChat component with scripted responses"
```

---

### Task 22: Create useManagerTriggers hook

**File:** `src/hooks/useManagerTriggers.ts`

**Step 1: Write hook**
```typescript
import { useEffect, useRef } from 'react';
import { useStore } from '../store';
import managerResponses from '../data/mock/manager-responses.json';

const HOVER_TRIGGER_MS = 30000; // 30 seconds
const HESITATION_WINDOW_MS = 45000;
const HESITATION_COUNT = 3;

export function useManagerTriggers() {
  const {
    selectedFilmId,
    currentAisle,
    showManager,
    addChatMessage,
    managerVisible,
  } = useStore();

  const hoverTimerRef = useRef<NodeJS.Timeout | null>(null);
  const lastHoveredFilmRef = useRef<number | null>(null);
  const recentHoversRef = useRef<number[]>([]);
  const aisleVisitsRef = useRef<Record<string, number>>({});

  // Track aisle visits
  useEffect(() => {
    aisleVisitsRef.current[currentAisle] =
      (aisleVisitsRef.current[currentAisle] || 0) + 1;

    // Trigger on 3rd return to same aisle
    if (aisleVisitsRef.current[currentAisle] === 3 && !managerVisible) {
      const aisleKey = currentAisle as keyof typeof managerResponses.aisles;
      const remark = managerResponses.aisles[aisleKey];
      if (remark) {
        showManager();
        addChatMessage('manager', remark);
      }
    }
  }, [currentAisle]);

  // Track film hover
  useEffect(() => {
    // Clear existing timer
    if (hoverTimerRef.current) {
      clearTimeout(hoverTimerRef.current);
      hoverTimerRef.current = null;
    }

    if (selectedFilmId === null) {
      lastHoveredFilmRef.current = null;
      return;
    }

    // Track for hesitation detection
    const now = Date.now();
    recentHoversRef.current = [
      ...recentHoversRef.current.filter(
        (timestamp) => now - timestamp < HESITATION_WINDOW_MS
      ),
      now,
    ];

    // Check hesitation trigger
    if (
      recentHoversRef.current.length >= HESITATION_COUNT &&
      !managerVisible
    ) {
      showManager();
      addChatMessage(
        'manager',
        "T'h√©sites, hein ? C'est normal. Dis-moi ce que tu cherches, je peux t'aiguiller."
      );
      recentHoversRef.current = [];
      return;
    }

    // Start 30s hover timer
    if (lastHoveredFilmRef.current !== selectedFilmId) {
      lastHoveredFilmRef.current = selectedFilmId;

      hoverTimerRef.current = setTimeout(() => {
        if (!managerVisible) {
          const filmData =
            managerResponses.films[
              String(selectedFilmId) as keyof typeof managerResponses.films
            ];
          if (filmData) {
            const anecdote =
              filmData.anecdotes[
                Math.floor(Math.random() * filmData.anecdotes.length)
              ];
            showManager();
            addChatMessage('manager', anecdote);
          } else {
            showManager();
            addChatMessage(
              'manager',
              "Celui-l√†... j'ai des choses √† dire dessus. Tu veux en parler ?"
            );
          }
        }
      }, HOVER_TRIGGER_MS);
    }

    return () => {
      if (hoverTimerRef.current) {
        clearTimeout(hoverTimerRef.current);
      }
    };
  }, [selectedFilmId, managerVisible]);

  // Post-rental trigger function (to be called after rental)
  const triggerPostRental = (filmId: number, isPositive: boolean) => {
    setTimeout(() => {
      const reactions = isPositive
        ? managerResponses.rentalReactions.positive
        : managerResponses.rentalReactions.neutral;
      const reaction = reactions[Math.floor(Math.random() * reactions.length)];
      showManager();
      addChatMessage('manager', reaction);
    }, 2000);
  };

  return { triggerPostRental };
}
```

**Step 2: Commit**
```bash
git add src/hooks/useManagerTriggers.ts && git commit -m "feat: create useManagerTriggers hook with 30s hover, hesitation, aisle return triggers"
```

---

## Phase 7: VHS Player Components

### Task 23: Create VHSEffects component

**File:** `src/components/player/VHSEffects.tsx`

**Step 1: Write component**
```tsx
import { useEffect, useRef } from 'react';
import type { PlayerState } from '../../types';
import styles from './VHSEffects.module.css';

interface VHSEffectsProps {
  playerState: PlayerState;
  intensity?: number;
}

export function VHSEffects({ playerState, intensity = 1 }: VHSEffectsProps) {
  const canvasRef = useRef<HTMLCanvasElement>(null);

  useEffect(() => {
    const canvas = canvasRef.current;
    if (!canvas) return;

    const ctx = canvas.getContext('2d');
    if (!ctx) return;

    let animationId: number;

    const render = () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Scanlines
      ctx.fillStyle = `rgba(0, 0, 0, ${0.03 * intensity})`;
      for (let y = 0; y < canvas.height; y += 2) {
        ctx.fillRect(0, y, canvas.width, 1);
      }

      // Film grain
      const grainIntensity = playerState === 'paused' ? 0.08 : 0.03;
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imageData.data;
      for (let i = 0; i < data.length; i += 4) {
        const noise = (Math.random() - 0.5) * 255 * grainIntensity * intensity;
        data[i] += noise;
        data[i + 1] += noise;
        data[i + 2] += noise;
      }
      ctx.putImageData(imageData, 0, 0);

      // Tracking lines (on pause)
      if (playerState === 'paused') {
        const time = Date.now() / 100;
        for (let i = 0; i < 3; i++) {
          const y = ((time * 50 + i * 100) % canvas.height);
          ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
          ctx.fillRect(0, y, canvas.width, 2 + Math.random() * 3);
        }
      }

      // Distortion (on rewind/ff)
      if (playerState === 'rewinding' || playerState === 'fastforwarding') {
        ctx.fillStyle = 'rgba(255, 255, 255, 0.05)';
        for (let i = 0; i < 10; i++) {
          const y = Math.random() * canvas.height;
          const h = 2 + Math.random() * 5;
          ctx.fillRect(0, y, canvas.width, h);
        }
      }

      animationId = requestAnimationFrame(render);
    };

    render();

    return () => cancelAnimationFrame(animationId);
  }, [playerState, intensity]);

  return (
    <canvas
      ref={canvasRef}
      className={styles.overlay}
      width={1920}
      height={1080}
    />
  );
}
```

**File:** `src/components/player/VHSEffects.module.css`

**Step 2: Write styles**
```css
.overlay {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  mix-blend-mode: overlay;
  opacity: 0.7;
}
```

**Step 3: Commit**
```bash
git add src/components/player/VHSEffects.tsx src/components/player/VHSEffects.module.css && git commit -m "feat: create VHSEffects component with grain, scanlines, tracking"
```

---

### Task 24: Create VHSControls component

**File:** `src/components/player/VHSControls.tsx`

**Step 1: Write component**
```tsx
import { useState, useEffect, useRef } from 'react';
import type { PlayerState } from '../../types';
import styles from './VHSControls.module.css';

interface VHSControlsProps {
  videoRef: React.RefObject<HTMLVideoElement>;
  playerState: PlayerState;
  onStateChange: (state: PlayerState) => void;
  onClose: () => void;
}

function formatTime(seconds: number): string {
  const h = Math.floor(seconds / 3600);
  const m = Math.floor((seconds % 3600) / 60);
  const s = Math.floor(seconds % 60);
  if (h > 0) {
    return `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
  }
  return `${m}:${s.toString().padStart(2, '0')}`;
}

export function VHSControls({
  videoRef,
  playerState,
  onStateChange,
  onClose,
}: VHSControlsProps) {
  const [currentTime, setCurrentTime] = useState(0);
  const [duration, setDuration] = useState(0);
  const [volume, setVolume] = useState(1);
  const [isMuted, setIsMuted] = useState(false);
  const progressRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    const video = videoRef.current;
    if (!video) return;

    const handleTimeUpdate = () => setCurrentTime(video.currentTime);
    const handleDurationChange = () => setDuration(video.duration);
    const handleVolumeChange = () => {
      setVolume(video.volume);
      setIsMuted(video.muted);
    };

    video.addEventListener('timeupdate', handleTimeUpdate);
    video.addEventListener('durationchange', handleDurationChange);
    video.addEventListener('volumechange', handleVolumeChange);

    return () => {
      video.removeEventListener('timeupdate', handleTimeUpdate);
      video.removeEventListener('durationchange', handleDurationChange);
      video.removeEventListener('volumechange', handleVolumeChange);
    };
  }, [videoRef]);

  const togglePlay = () => {
    const video = videoRef.current;
    if (!video) return;

    if (playerState === 'playing') {
      video.pause();
      onStateChange('paused');
    } else {
      video.play();
      onStateChange('playing');
    }
  };

  const handleSeek = (e: React.MouseEvent<HTMLDivElement>) => {
    const video = videoRef.current;
    const progress = progressRef.current;
    if (!video || !progress) return;

    const rect = progress.getBoundingClientRect();
    const percent = (e.clientX - rect.left) / rect.width;
    video.currentTime = percent * duration;
    onStateChange('seeking');
    setTimeout(() => onStateChange(video.paused ? 'paused' : 'playing'), 300);
  };

  const skip = (seconds: number) => {
    const video = videoRef.current;
    if (!video) return;
    video.currentTime = Math.max(0, Math.min(duration, video.currentTime + seconds));
  };

  const toggleMute = () => {
    const video = videoRef.current;
    if (!video) return;
    video.muted = !video.muted;
  };

  const toggleFullscreen = () => {
    if (document.fullscreenElement) {
      document.exitFullscreen();
    } else {
      document.documentElement.requestFullscreen();
    }
  };

  const progress = duration > 0 ? (currentTime / duration) * 100 : 0;

  return (
    <div className={styles.controls}>
      <div className={styles.progress} ref={progressRef} onClick={handleSeek}>
        <div className={styles.progressFill} style={{ width: `${progress}%` }} />
        <div className={styles.progressHead} style={{ left: `${progress}%` }} />
      </div>

      <div className={styles.buttons}>
        <div className={styles.left}>
          <button onClick={() => skip(-10)} className={styles.btn}>‚èÆ</button>
          <button onClick={() => { onStateChange('rewinding'); skip(-30); }} className={styles.btn}>‚óÄ‚óÄ</button>
          <button onClick={togglePlay} className={`${styles.btn} ${styles.playBtn}`}>
            {playerState === 'playing' ? '‚è∏' : '‚ñ∂'}
          </button>
          <button onClick={() => { onStateChange('fastforwarding'); skip(30); }} className={styles.btn}>‚ñ∂‚ñ∂</button>
          <button onClick={() => skip(10)} className={styles.btn}>‚è≠</button>
        </div>

        <div className={styles.time}>
          {formatTime(currentTime)} / {formatTime(duration)}
        </div>

        <div className={styles.right}>
          <button onClick={toggleMute} className={styles.btn}>
            {isMuted ? 'üîá' : 'üîä'}
          </button>
          <input
            type="range"
            min="0"
            max="1"
            step="0.1"
            value={isMuted ? 0 : volume}
            onChange={(e) => {
              const video = videoRef.current;
              if (video) video.volume = parseFloat(e.target.value);
            }}
            className={styles.volumeSlider}
          />
          <button onClick={toggleFullscreen} className={styles.btn}>‚õ∂</button>
          <button onClick={onClose} className={styles.btn}>‚úï</button>
        </div>
      </div>
    </div>
  );
}
```

**File:** `src/components/player/VHSControls.module.css`

**Step 2: Write styles**
```css
.controls {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  background: linear-gradient(transparent, rgba(0, 0, 0, 0.9));
  padding: var(--space-lg);
  padding-top: var(--space-xl);
}

.progress {
  height: 6px;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 3px;
  cursor: pointer;
  position: relative;
  margin-bottom: var(--space-md);
}

.progressFill {
  height: 100%;
  background: var(--neon-pink);
  border-radius: 3px;
  box-shadow: var(--glow-pink);
}

.progressHead {
  position: absolute;
  top: 50%;
  transform: translate(-50%, -50%);
  width: 14px;
  height: 14px;
  background: var(--neon-pink);
  border-radius: 50%;
  box-shadow: var(--glow-pink);
}

.buttons {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.left, .right {
  display: flex;
  align-items: center;
  gap: var(--space-sm);
}

.btn {
  background: none;
  border: none;
  color: white;
  font-size: 1.25rem;
  cursor: pointer;
  padding: var(--space-sm);
  transition: transform var(--transition-fast), color var(--transition-fast);
}

.btn:hover {
  transform: scale(1.1);
  color: var(--neon-cyan);
}

.playBtn {
  font-size: 1.5rem;
  background: var(--neon-pink);
  border-radius: 50%;
  width: 50px;
  height: 50px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: var(--glow-pink);
}

.playBtn:hover {
  color: white;
}

.time {
  font-family: var(--font-display);
  font-size: 0.875rem;
  color: var(--neon-cyan);
  letter-spacing: 0.05em;
}

.volumeSlider {
  width: 80px;
  accent-color: var(--neon-cyan);
}
```

**Step 3: Commit**
```bash
git add src/components/player/VHSControls.tsx src/components/player/VHSControls.module.css && git commit -m "feat: create VHSControls component with VCR-style buttons"
```

---

### Task 25: Create VHSPlayer component

**File:** `src/components/player/VHSPlayer.tsx`

**Step 1: Write component**
```tsx
import { useRef, useState, useEffect } from 'react';
import { useStore } from '../../store';
import { VHSEffects } from './VHSEffects';
import { VHSControls } from './VHSControls';
import { RentalTimer } from '../ui/RentalTimer';
import type { PlayerState } from '../../types';
import styles from './VHSPlayer.module.css';

export function VHSPlayer() {
  const { isPlayerOpen, currentPlayingFilm, closePlayer, getRental } = useStore();
  const videoRef = useRef<HTMLVideoElement>(null);
  const [playerState, setPlayerState] = useState<PlayerState>('paused');
  const [showEndMessage, setShowEndMessage] = useState(false);

  const rental = currentPlayingFilm ? getRental(currentPlayingFilm) : null;

  // Keyboard controls
  useEffect(() => {
    if (!isPlayerOpen) return;

    const handleKeyDown = (e: KeyboardEvent) => {
      const video = videoRef.current;
      if (!video) return;

      switch (e.key) {
        case ' ':
          e.preventDefault();
          if (video.paused) {
            video.play();
            setPlayerState('playing');
          } else {
            video.pause();
            setPlayerState('paused');
          }
          break;
        case 'ArrowLeft':
          video.currentTime -= 10;
          break;
        case 'ArrowRight':
          video.currentTime += 10;
          break;
        case 'f':
          document.documentElement.requestFullscreen();
          break;
        case 'm':
          video.muted = !video.muted;
          break;
        case 'Escape':
          closePlayer();
          break;
      }
    };

    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [isPlayerOpen, closePlayer]);

  // Handle video end
  useEffect(() => {
    const video = videoRef.current;
    if (!video) return;

    const handleEnded = () => {
      setShowEndMessage(true);
      setTimeout(() => setShowEndMessage(false), 3000);
    };

    video.addEventListener('ended', handleEnded);
    return () => video.removeEventListener('ended', handleEnded);
  }, []);

  if (!isPlayerOpen || !rental) return null;

  return (
    <div className={styles.player}>
      <video
        ref={videoRef}
        src={rental.videoUrl}
        className={styles.video}
        autoPlay
        onPlay={() => setPlayerState('playing')}
        onPause={() => setPlayerState('paused')}
      />

      <VHSEffects playerState={playerState} />

      <div className={styles.rentalTimer}>
        <RentalTimer expiresAt={rental.expiresAt} />
      </div>

      {showEndMessage && (
        <div className={styles.endMessage}>
          BE KIND<br />REWIND
        </div>
      )}

      <VHSControls
        videoRef={videoRef}
        playerState={playerState}
        onStateChange={setPlayerState}
        onClose={closePlayer}
      />
    </div>
  );
}
```

**File:** `src/components/player/VHSPlayer.module.css`

**Step 2: Write styles**
```css
.player {
  position: fixed;
  inset: 0;
  background: black;
  z-index: 300;
  display: flex;
  align-items: center;
  justify-content: center;
}

.video {
  width: 100%;
  height: 100%;
  object-fit: contain;
}

.rentalTimer {
  position: absolute;
  top: var(--space-lg);
  right: var(--space-lg);
  z-index: 10;
}

.endMessage {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-family: var(--font-display);
  font-size: 4rem;
  color: var(--neon-cyan);
  text-shadow: var(--glow-cyan);
  text-align: center;
  letter-spacing: 0.2em;
  animation: flicker 0.5s infinite;
  z-index: 20;
}

@keyframes flicker {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.8; }
  75% { opacity: 0.9; }
}
```

**Step 3: Commit**
```bash
git add src/components/player/VHSPlayer.tsx src/components/player/VHSPlayer.module.css && git commit -m "feat: create VHSPlayer component with effects, controls, keyboard shortcuts"
```

---

## Phase 8: Main App Integration

### Task 26: Create App component

**File:** `src/App.tsx`

**Step 1: Write component**
```tsx
import { useRef, useEffect, useState } from 'react';
import { useStore } from './store';
import { useWebGPU } from './hooks/useWebGPU';
import { useManagerTriggers } from './hooks/useManagerTriggers';
import { tmdb } from './services/tmdb';
import { Header } from './components/ui/Header';
import { FilmDetailModal } from './components/videoclub/FilmDetailModal';
import { MesLocations } from './components/videoclub/MesLocations';
import { ManagerChat } from './components/manager/ManagerChat';
import { VHSPlayer } from './components/player/VHSPlayer';
import filmsData from './data/mock/films.json';
import type { Film, AisleType } from './types';
import styles from './App.module.css';

const AISLES: AisleType[] = ['nouveautes', 'action', 'horreur', 'sf', 'comedie', 'classiques', 'bizarre'];

export default function App() {
  const canvasRef = useRef<HTMLCanvasElement>(null);
  const { gpuContext, error: gpuError, isLoading: gpuLoading } = useWebGPU(canvasRef);

  const {
    currentAisle,
    setAisle,
    selectedFilmId,
    selectFilm,
    films,
    setFilmsForAisle,
    isPlayerOpen,
  } = useStore();

  const { triggerPostRental } = useManagerTriggers();

  const [selectedFilm, setSelectedFilm] = useState<Film | null>(null);
  const [showLocations, setShowLocations] = useState(false);

  // Fetch films for current aisle
  useEffect(() => {
    const fetchAisleFilms = async () => {
      if (films[currentAisle].length > 0) return;

      const filmIds = filmsData[currentAisle as keyof typeof filmsData] || [];
      const fetchedFilms = await tmdb.getFilms(filmIds);
      setFilmsForAisle(currentAisle, fetchedFilms);
    };

    fetchAisleFilms();
  }, [currentAisle]);

  // Fetch selected film details
  useEffect(() => {
    if (selectedFilmId === null) {
      setSelectedFilm(null);
      return;
    }

    const fetchFilm = async () => {
      const film = await tmdb.getFilm(selectedFilmId);
      setSelectedFilm(film);
    };

    fetchFilm();
  }, [selectedFilmId]);

  if (gpuError) {
    return (
      <div className={styles.error}>
        <h1>WebGPU non support√©</h1>
        <p>{gpuError}</p>
        <p>Utilise Chrome 113+ ou Edge 113+</p>
      </div>
    );
  }

  return (
    <div className={styles.app}>
      <Header />

      {/* WebGPU Canvas - placeholder for now */}
      <canvas ref={canvasRef} className={styles.canvas} />

      {/* Temporary 2D UI until WebGPU is implemented */}
      <div className={styles.tempUI}>
        <div className={styles.aisleNav}>
          {AISLES.map((aisle) => (
            <button
              key={aisle}
              className={`${styles.aisleBtn} ${currentAisle === aisle ? styles.active : ''}`}
              onClick={() => setAisle(aisle)}
            >
              {aisle.toUpperCase()}
            </button>
          ))}
        </div>

        <div className={styles.filmGrid}>
          {films[currentAisle].map((film) => (
            <div
              key={film.id}
              className={styles.filmCard}
              onClick={() => selectFilm(film.id)}
            >
              <img
                src={tmdb.posterUrl(film.poster_path, 'w342')}
                alt={film.title}
                className={styles.filmPoster}
              />
              <span className={styles.filmTitle}>{film.title}</span>
            </div>
          ))}
        </div>

        <button
          className={styles.locationsBtn}
          onClick={() => setShowLocations(!showLocations)}
        >
          Mes Locations
        </button>
      </div>

      {showLocations && (
        <div className={styles.locationsPanel}>
          <MesLocations />
          <button onClick={() => setShowLocations(false)}>Fermer</button>
        </div>
      )}

      <FilmDetailModal
        film={selectedFilm}
        isOpen={selectedFilmId !== null}
        onClose={() => selectFilm(null)}
      />

      <ManagerChat />
      <VHSPlayer />
    </div>
  );
}
```

**File:** `src/App.module.css`

**Step 2: Write styles**
```css
.app {
  min-height: 100vh;
  background: var(--darker-bg);
}

.error {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  text-align: center;
  color: var(--neon-pink);
}

.error h1 {
  font-family: var(--font-display);
  text-shadow: var(--glow-pink);
}

.canvas {
  position: fixed;
  inset: 0;
  width: 100%;
  height: 100%;
  z-index: 0;
}

.tempUI {
  position: relative;
  z-index: 10;
  padding: 80px var(--space-lg) var(--space-lg);
}

.aisleNav {
  display: flex;
  gap: var(--space-sm);
  margin-bottom: var(--space-xl);
  flex-wrap: wrap;
}

.aisleBtn {
  padding: var(--space-sm) var(--space-md);
  background: transparent;
  border: 1px solid var(--neon-purple);
  border-radius: 4px;
  color: var(--neon-purple);
  font-family: var(--font-display);
  font-size: 0.75rem;
  cursor: pointer;
  transition: all var(--transition-fast);
}

.aisleBtn:hover, .aisleBtn.active {
  background: var(--neon-purple);
  color: white;
  box-shadow: var(--glow-purple);
}

.filmGrid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: var(--space-lg);
}

.filmCard {
  cursor: pointer;
  transition: transform var(--transition-fast);
}

.filmCard:hover {
  transform: scale(1.05);
}

.filmPoster {
  width: 100%;
  aspect-ratio: 2/3;
  object-fit: cover;
  border-radius: 4px;
  border: 2px solid transparent;
  transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
}

.filmCard:hover .filmPoster {
  border-color: var(--neon-pink);
  box-shadow: var(--glow-pink);
}

.filmTitle {
  display: block;
  margin-top: var(--space-sm);
  font-size: 0.875rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.locationsBtn {
  position: fixed;
  bottom: var(--space-lg);
  right: var(--space-lg);
  padding: var(--space-md) var(--space-lg);
  background: var(--neon-cyan);
  border: none;
  border-radius: 4px;
  color: var(--darker-bg);
  font-family: var(--font-display);
  cursor: pointer;
  box-shadow: var(--glow-cyan);
  z-index: 50;
}

.locationsPanel {
  position: fixed;
  top: 60px;
  right: 0;
  bottom: 0;
  width: 400px;
  background: var(--card-bg);
  border-left: 1px solid var(--neon-cyan);
  z-index: 100;
  overflow-y: auto;
}
```

**Step 3: Commit**
```bash
git add src/App.tsx src/App.module.css && git commit -m "feat: create main App with temporary 2D UI, film grid, modals integration"
```

---

### Task 27: Final cleanup and verification

**Step 1: Verify project runs**
```bash
npm run dev
```
Expected: App runs at localhost:5173 with film grid visible

**Step 2: Run type check**
```bash
npx tsc --noEmit
```
Expected: No TypeScript errors

**Step 3: Final commit**
```bash
git add -A && git commit -m "chore: complete MVP Phase 1 implementation"
```

---

## Summary

This plan covers:
- **16 Tasks in Part 1**: Project setup, types, store, services, WebGPU shaders, UI components (Header, Modal, RentalTimer)
- **11 Tasks in Part 2**: FilmDetailModal, MesLocations, Manager components, VHS Player, App integration

**Total: 27 tasks**

**What's working after this plan:**
- Film browsing by aisle (2D grid, WebGPU 3D is placeholder)
- Film detail modal with rental
- Credit system (5 initial, deduction on rent)
- Manager chat with scripted responses
- Manager triggers (30s hover, hesitation, aisle return)
- VHS Player with effects and controls
- Rental timer with expiration
- localStorage persistence

**Not yet implemented (Phase 2):**
- Full WebGPU 3D scene rendering (entrance, aisle, cassettes)
- Entrance scene animation
- Cassette 3D objects with interaction
- Rental bag animation
- Sound effects
